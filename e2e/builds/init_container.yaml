apiVersion: v1
kind: Secret
metadata:
  name: test-init-container-secret
data:
  api-key: bXktc2VjcmV0LWFwaS1rZXk=
  username: bXktc2VjcmV0LXVzZXJuYW1l
type: Opaque
---
apiVersion: forge.dominodatalab.com/v1alpha1
kind: ContainerImageBuild
metadata:
  name: ${TEST_RESOURCE_NAME}
spec:
  imageName: init-container-files
  context: https://forge-builder-test.s3-us-west-2.amazonaws.com/test-init-container.tar.gz
  disableBuildCache: true
  pushTo:
    - docker-registry-2:5000
  registries:
    - server: docker-registry-2:5000
      nonSSL: true
      basicAuth:
        username: marge
        password: simpson
  initContainers:
    - name: "test-init"
      image: "busybox"
      command: ["/bin/sh"]
      args:
        - "-c"
        - "mkdir -p $TARGET_DIR && echo $MESSAGE > $TARGET_DIR/init-container-generated.txt && echo ${SECRET_USERNAME}:${SECRET_API_KEY} > $TARGET_DIR/secret.txt"
      env:
        - name: MESSAGE
          value: "File generated by init container"
        - name: TARGET_DIR
          value: "extracted/files/app"
        - name: SECRET_USERNAME
          valueFrom:
            secretKeyRef:
              name: test-init-container-secret
              key: username
        - name: SECRET_API_KEY
          valueFrom:
            secretKeyRef:
              name: test-init-container-secret
              key: api-key

