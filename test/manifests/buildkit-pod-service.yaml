apiVersion: v1
kind: Pod
metadata:
  name: buildkitd
  labels:
    app: buildkitd
spec:
  containers:
    - name: buildkitd
      image: moby/buildkit:master
      args:
        - --debug
        - --addr
        - unix:///run/buildkit/buildkitd.sock
        - --addr
        - tcp://0.0.0.0:1234
      readinessProbe:
        exec:
          command:
            - buildctl
            - debug
            - workers
        initialDelaySeconds: 5
        periodSeconds: 30
      livenessProbe:
        exec:
          command:
            - buildctl
            - debug
            - workers
        initialDelaySeconds: 5
        periodSeconds: 30
      securityContext:
        privileged: true

---
apiVersion: v1
kind: Service
metadata:
  labels:
    app: buildkitd
  name: buildkitd
spec:
  ports:
    - nodePort: 30138
      port: 1234
      protocol: TCP
  selector:
    app: buildkitd
  type: NodePort